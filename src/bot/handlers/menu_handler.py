# src/bot/handlers/menu_handler.py

"""
SpaceAI Training Center ‚Äî Main Menu Handler

–†–æ–ª—å:
- Thin-client UI –¥–ª—è –¥–µ–º–æ-—ç–∫–æ—Å–∏—Å—Ç–µ–º—ã SpaceAI
- –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É –æ–±—É—á–µ–Ω–∏–µ–º –∞–≥–µ–Ω—Ç–æ–≤, —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏ –∏ –ª–æ–≥–∏–∫–æ–π UAG
- –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –æ–±—É—á–∞–µ–º–æ—Å—Ç–∏, –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –∏ –∞–≥–µ–Ω—Ç–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

–ü—Ä–∏–Ω—Ü–∏–ø—ã:
- Telegram = viewer
- –ù–µ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- –ù–µ—Ç –ò–ò-–ª–æ–≥–∏–∫–∏
- –ì–æ—Ç–æ–≤–æ –∫ i18n / CMS / A/B
"""

from aiogram import Router
from aiogram.types import (
    Message,
    CallbackQuery,
    InlineKeyboardMarkup,
    InlineKeyboardButton,
)
from aiogram.filters import CommandStart
from aiogram.exceptions import TelegramBadRequest
import logging

router = Router()
logger = logging.getLogger(__name__)

# ============================================================
# –¢–ï–ö–°–¢–´ –≠–ö–†–ê–ù–û–í (–≥–æ—Ç–æ–≤—ã –∫ i18n / CMS)
# ============================================================

MENU_TEXT = {
    "start": (
        "ü§ñ <b>SpaceAI Training Center</b>\n\n"
        "–î–µ–º–æ —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –æ–±—É—á–∞–µ–º—ã—Ö AI-–∞–≥–µ–Ω—Ç–æ–≤.\n\n"
        "–ó–¥–µ—Å—å —Ç—ã —É–≤–∏–¥–∏—à—å:\n"
        "‚Ä¢ –∫–∞–∫ –æ–±—É—á–∞—é—Ç—Å—è –∞–≥–µ–Ω—Ç—ã\n"
        "‚Ä¢ –∫–∞–∫ UAG –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è\n"
        "‚Ä¢ –∫–∞–∫ –≤—Å—ë –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –∏ –æ–±—ä—è—Å–Ω—è–µ—Ç—Å—è\n\n"
        "üëá –í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:"
    ),
    "train_agent": (
        "üìñ <b>–û–±—É—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞</b>\n\n"
        "–ê–≥–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç:\n"
        "‚Ä¢ —Ä–æ–ª—å –∏ –ø—Ä–æ—Ñ–∏–ª—å\n"
        "‚Ä¢ –Ω–∞—á–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞ (L0)\n"
        "‚Ä¢ –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã —á–µ—Ä–µ–∑ UAG\n\n"
        "–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —É—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–∞–µ—Ç—Å—è."
    ),
    "train_builder": (
        "üèó <b>–ü—Ä–æ—Ñ–∏–ª—å: –°—Ç—Ä–æ–∏—Ç–µ–ª—å</b>\n\n"
        "–†–æ–ª—å: —Å—Ç—Ä–æ–∏—Ç–µ–ª—å / –ø—Ä–æ—Ä–∞–±\n"
        "–£—Ä–æ–≤–µ–Ω—å: L0\n\n"
        "–ù–∞–≤—ã–∫–∏:\n"
        "‚Ä¢ —Ä–∞—Å—á—ë—Ç –æ–±—ä—ë–º–æ–≤\n"
        "‚Ä¢ –∑–∞–ø—Ä–æ—Å —Ü–µ–Ω\n"
        "‚Ä¢ –≤—ã–±–æ—Ä –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞\n\n"
        "‚ö†Ô∏è –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –∏–¥—É—Ç —á–µ—Ä–µ–∑ UAG."
    ),
    "train_shop": (
        "üì¶ <b>–ü—Ä–æ—Ñ–∏–ª—å: –ú–∞–≥–∞–∑–∏–Ω</b>\n\n"
        "–†–æ–ª—å: –ø–æ—Å—Ç–∞–≤—â–∏–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤\n"
        "–£—Ä–æ–≤–µ–Ω—å: L0\n\n"
        "–ù–∞–≤—ã–∫–∏:\n"
        "‚Ä¢ —Ü–µ–Ω—ã\n"
        "‚Ä¢ –æ–±—ä—ë–º—ã\n"
        "‚Ä¢ —Å—Ä–æ–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏\n\n"
        "‚õî –ú–∞–≥–∞–∑–∏–Ω –Ω–µ –∑–Ω–∞–µ—Ç –æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞—Ö."
    ),
    "scenario": (
        "üìú <b>–≠—Ç–∞–ª–æ–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π</b>\n\n"
        "1Ô∏è‚É£ –°—Ç—Ä–æ–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–¥–∞—á—É\n"
        "2Ô∏è‚É£ –°—á–∏—Ç–∞–µ—Ç –æ–±—ä—ë–º—ã\n"
        "3Ô∏è‚É£ –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç 3 –º–∞–≥–∞–∑–∏–Ω–∞\n"
        "4Ô∏è‚É£ UAG —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ü–µ–Ω—É / –æ–±—ä—ë–º / —Å—Ä–æ–∫–∏\n"
        "5Ô∏è‚É£ –í—ã–±–∏—Ä–∞–µ—Ç—Å—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ\n"
        "6Ô∏è‚É£ –ê–≥–µ–Ω—Ç –ø–æ–≤—ã—à–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å\n\n"
        "üìä –í—Å—ë –æ–±—ä—è—Å–Ω–∏–º–æ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º–æ."
    ),
    "logic": (
        "üß† <b>–ü–æ—á–µ–º—É –ø—Ä–∏–Ω—è—Ç–æ —Ç–∞–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ?</b>\n\n"
        "UAG —É—á–∏—Ç—ã–≤–∞–µ—Ç:\n"
        "‚Ä¢ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞\n"
        "‚Ä¢ –¥–µ—Ñ–∏—Ü–∏—Ç –æ–±—ä—ë–º–∞\n"
        "‚Ä¢ —Å—Ä–æ–∫–∏ –ø–æ—Å—Ç–∞–≤–∫–∏\n\n"
        "‚ùå –î–µ—à–µ–≤–ª–µ ‚â† –ª—É—á—à–µ\n"
        "‚úî –†–µ—à–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º."
    ),
    "calendar": (
        "üìÖ <b>–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç—á—ë—Ç—ã</b>\n\n"
        "–ê–≥–µ–Ω—Ç —É–º–µ–µ—Ç:\n"
        "‚Ä¢ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–∞–ø—ã\n"
        "‚Ä¢ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è\n"
        "‚Ä¢ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç\n\n"
        "‚è≥ –í–∏–∑—É–∞–ª—å–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å ‚Äî —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø."
    ),
    "about": (
        "‚ÑπÔ∏è <b>–û –ø—Ä–æ–µ–∫—Ç–µ</b>\n\n"
        "SpaceAI ‚Äî —ç—Ç–æ:\n"
        "‚Ä¢ –æ–±—É—á–∞–µ–º—ã–µ AI-–∞–≥–µ–Ω—Ç—ã\n"
        "‚Ä¢ UAG ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π —Å–ª–æ–π —Ä–µ—à–µ–Ω–∏–π\n"
        "‚Ä¢ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –∞—É–¥–∏—Ç, –æ–±—ä—è—Å–Ω–∏–º–æ—Å—Ç—å\n\n"
        "üéØ –î–µ–º–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±—É–¥—É—â–µ–µ –∞–≥–µ–Ω—Ç–Ω—ã—Ö —Å–∏—Å—Ç–µ–º."
    ),
}

# ============================================================
# CALLBACK ‚Üí TEXT KEY
# ============================================================

CALLBACK_TO_TEXT = {
    "menu:train:agent": "train_agent",
    "menu:train:builder": "train_builder",
    "menu:train:shop": "train_shop",
    "menu:scenario": "scenario",
    "menu:logic": "logic",
    "menu:calendar": "calendar",
    "menu:about": "about",
    "menu:main": "start",
}

# ============================================================
# –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ
# ============================================================

def main_menu() -> InlineKeyboardMarkup:
    """
    –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é SpaceAI Training Center.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–∞—Ö.
    """
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton("üìñ –û–±—É—á–∏—Ç—å –Ω–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞", callback_data="menu:train:agent")],
            [
                InlineKeyboardButton("üèó –°—Ç—Ä–æ–∏—Ç–µ–ª—å", callback_data="menu:train:builder"),
                InlineKeyboardButton("üì¶ –ú–∞–≥–∞–∑–∏–Ω", callback_data="menu:train:shop"),
            ],
            [InlineKeyboardButton("üìú –≠—Ç–∞–ª–æ–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π", callback_data="menu:scenario")],
            [InlineKeyboardButton("üß† –õ–æ–≥–∏–∫–∞ —Ä–µ—à–µ–Ω–∏–π", callback_data="menu:logic")],
            [InlineKeyboardButton("üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∏ –æ—Ç—á—ë—Ç—ã", callback_data="menu:calendar")],
            [InlineKeyboardButton("‚ÑπÔ∏è –û –ø—Ä–æ–µ–∫—Ç–µ", callback_data="menu:about")],
        ]
    )

# ============================================================
# SAFE EDIT
# ============================================================

async def safe_edit(call: CallbackQuery, text: str) -> None:
    if not call.message:
        return
    try:
        await call.message.edit_text(
            text=text,
            parse_mode="HTML",
            reply_markup=main_menu(),
        )
    except TelegramBadRequest as e:
        if "message is not modified" not in str(e):
            logger.warning(f"Edit failed: {e}")

# ============================================================
# /start
# ============================================================

@router.message(CommandStart())
async def start_cmd(message: Message):
    await message.answer(
        text=MENU_TEXT["start"],
        parse_mode="HTML",
        reply_markup=main_menu(),
    )

# ============================================================
# CALLBACK ROUTER
# ============================================================

@router.callback_query()
async def menu_router(call: CallbackQuery):
    data = call.data or ""

    if data in CALLBACK_TO_TEXT:
        key = CALLBACK_TO_TEXT[data]
        await safe_edit(call, MENU_TEXT[key])
    else:
        logger.warning(f"Unknown callback_data: {data}")
        await call.answer("‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞", show_alert=False)

    await call.answer(cache_time=1)
